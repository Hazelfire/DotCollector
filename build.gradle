/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds/
 */

import com.amazonaws.services.s3.model.ObjectMetadata;

import jp.classmethod.aws.gradle.s3.CreateBucketTask;
import jp.classmethod.aws.gradle.s3.SyncTask;

plugins {
  id "jp.classmethod.aws" version "0.37"
  id "com.moowork.node" version "1.2.0"
}

aws {
  profileName = "default"
  region = "ap-southeast-2"
}

task createDevBucket(type: CreateBucketTask){
  bucketName "dotcollectordev-${aws.region}-${aws.accountId}"
  region "ap-southeast-2"
  ifNotExists true
}

apply plugin: 'jp.classmethod.aws.cloudformation'

cloudFormation{
  templateFile project.file('api/template.yaml')
  templateBucket "dotcollectordev-${aws.region}-${aws.accountId}"
  region "ap-southeast-2"
  templateKeyPrefix 'template.yaml'
  stackName 'dotcollector'
}

task deployCloudformation(dependsOn: [
  createDevBucket,
  awsCfnUploadTemplate,
  awsCfnMigrateStackAndWaitCompleted
])

task installReactDependencies(type: NpmTask){
  args = ["install", "--prefix", "react"]
}

task buildReactProject(type: NpmTask, dependsOn: installReactDependencies){
  args = ["run", "build", "--prefix", "react"]
}

task moveDistFolderToBucket(type: SyncTask, dependsOn: buildReactProject){
  source file("react/dist")
  bucketName "dot.hazelfire.org"
  prefix "dist/"
}

task moveHtmlFolderToBucket(type: SyncTask, dependsOn: buildReactProject){
  source file("react/html")
  bucketName "dot.hazelfire.org"
  prefix "html/"
  acl "PublicRead"
}

task moveWebsiteToBuckets(dependsOn: [
  moveDistFolderToBucket,
  moveHtmlFolderToBucket
])

task fullBuild(dependsOn:[
  deployCloudformation,
  moveWebsiteToBuckets
])
